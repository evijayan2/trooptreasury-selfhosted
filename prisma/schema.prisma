generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Troop {
  id                   String                @id @default(uuid())
  name                 String
  slug                 String                @unique
  council              String?
  district             String?
  settings             Json?
  status               TroopStatus           @default(ACTIVE)
  deactivatedAt        DateTime?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  budgets              Budget[]
  campouts             Campout[]
  fundraisingCampaigns FundraisingCampaign[]
  scouts               Scout[]
  subscription         Subscription?
  transactions         Transaction[]
  members              TroopMember[]
}

model Subscription {
  id                   String    @id @default(uuid())
  troopId              String    @unique
  planId               String
  status               String
  stripeCustomerId     String    @unique
  stripeSubscriptionId String?   @unique
  currentPeriodEnd     DateTime
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  cancelAtPeriodEnd    Boolean   @default(false)
  canceledAt           DateTime?
  trialStart           DateTime?
  trialEnd             DateTime?
  pausedAt             DateTime?
  isPaused             Boolean   @default(false)
  discountCode         String?
  discountEnd          DateTime?
  troop                Troop     @relation(fields: [troopId], references: [id], onDelete: Cascade)
}

model PendingRegistration {
  id              String   @id @default(uuid())
  email           String   @unique
  name            String
  troopName       String
  troopSlug       String
  council         String
  district        String?
  passwordHash    String
  expiresAt       DateTime
  createdAt       DateTime @default(now())
  stripeSessionId String?  @unique
}

model TroopMember {
  id        String   @id @default(uuid())
  troopId   String
  userId    String
  role      Role     @default(SCOUT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  troop     Troop    @relation(fields: [troopId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([troopId, userId])
}

model User {
  id                   String                      @id @default(uuid())
  email                String                      @unique
  name                 String?
  passwordHash         String?
  role                 Role                        @default(SCOUT)
  createdAt            DateTime                    @default(now())
  updatedAt            DateTime                    @updatedAt
  isActive             Boolean                     @default(true)
  deactivatedAt        DateTime?
  invitationToken      String?                     @unique
  invitationExpires    DateTime?
  failedLoginAttempts  Int                         @default(0)
  lockedUntil          DateTime?
  lastFailedLogin      DateTime?
  preferredTheme       String?                     @default("system")
  preferredColor       String?                     @default("orange")
  pushToken            String?
  adminEmailAlerts     Boolean                     @default(true)
  adminSmsAlerts       Boolean                     @default(false)
  adminAlertTypes      Json?
  auditLogs            AdminAuditLog[]
  adultExpenses        AdultExpense[]
  campouts             CampoutAdult[]              @relation("CampoutAdults")
  directSalesVolunteer DirectSalesGroupVolunteer[]
  notifications        Notification[]
  parentLinks          ParentScout[]               @relation("Parent")
  scout                Scout?
  approvedTransactions Transaction[]               @relation("ApprovedBy")
  transactions         Transaction[]               @relation("UserTransactions")
  troopMemberships     TroopMember[]
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType @default(INFO)
  title     String
  message   String
  link      String?
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Scout {
  id                   String                      @id @default(uuid())
  troopId              String
  name                 String
  age                  Int?
  ibaBalance           Decimal                     @default(0.00) @db.Decimal(10, 2)
  status               ScoutStatus                 @default(ACTIVE)
  createdAt            DateTime                    @default(now())
  updatedAt            DateTime                    @updatedAt
  userId               String?                     @unique
  email                String?                     @unique
  campouts             CampoutScout[]
  directSalesVolunteer DirectSalesGroupVolunteer[]
  orders               FundraisingOrder[]
  sales                FundraisingSale[]
  volunteering         FundraisingVolunteer[]
  parentLinks          ParentScout[]
  troop                Troop                       @relation(fields: [troopId], references: [id])
  user                 User?                       @relation(fields: [userId], references: [id])
  transactions         Transaction[]
  eagleProjects        EagleProject[]
}

model ParentScout {
  parentId String
  scoutId  String
  parent   User   @relation("Parent", fields: [parentId], references: [id])
  scout    Scout  @relation(fields: [scoutId], references: [id])

  @@id([parentId, scoutId])
}

model CampoutScout {
  campoutId    String
  scoutId      String
  status       RegistrationStatus @default(RESERVED)
  registeredAt DateTime           @default(now())
  campout      Campout            @relation(fields: [campoutId], references: [id])
  scout        Scout              @relation(fields: [scoutId], references: [id])

  @@id([campoutId, scoutId])

}

model Campout {
  id            String         @id @default(uuid())
  troopId       String
  name          String
  startDate     DateTime
  endDate       DateTime?
  location      String?
  description   String?
  scoutLimit    Int?
  adultLimit    Int?
  estimatedCost Decimal?       @db.Decimal(10, 2)
  status        CampoutStatus  @default(DRAFT)

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  expenses      AdultExpense[]
  troop         Troop          @relation(fields: [troopId], references: [id])
  adults        CampoutAdult[]
  scouts        CampoutScout[]
  transactions  Transaction[]
}

model CampoutAdult {
  campoutId String
  adultId   String
  role      CampoutAdultRole   @default(ORGANIZER)
  status    RegistrationStatus @default(RESERVED)
  createdAt DateTime           @default(now())
  adult     User               @relation("CampoutAdults", fields: [adultId], references: [id])
  campout   Campout            @relation(fields: [campoutId], references: [id])

  @@id([campoutId, adultId, role])

}

model Transaction {
  id                    String               @id @default(uuid())
  troopId               String
  type                  TransactionType
  amount                Decimal              @db.Decimal(10, 2)
  description           String?
  fromAccount           String?
  toAccount             String?
  scoutId               String?
  userId                String?
  campoutId             String?
  approvedBy            String?
  status                TransactionStatus    @default(PENDING)
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  budgetCategoryId      String?
  fundraisingCampaignId String?
  approvedByUser        User?                @relation("ApprovedBy", fields: [approvedBy], references: [id])
  budgetCategory        BudgetCategory?      @relation(fields: [budgetCategoryId], references: [id])
  campout               Campout?             @relation(fields: [campoutId], references: [id])
  fundraisingCampaign   FundraisingCampaign? @relation(fields: [fundraisingCampaignId], references: [id])
  scout                 Scout?               @relation(fields: [scoutId], references: [id])
  troop                 Troop                @relation(fields: [troopId], references: [id])
  user                  User?                @relation("UserTransactions", fields: [userId], references: [id])
}

model AdultExpense {
  id           String   @id @default(uuid())
  campoutId    String
  adultId      String
  amount       Decimal  @db.Decimal(10, 2)
  description  String
  category     String?
  createdAt    DateTime @default(now())
  isReimbursed Boolean  @default(false)
  adult        User     @relation(fields: [adultId], references: [id])
  campout      Campout  @relation(fields: [campoutId], references: [id])
}

model TroopSettings {
  id                    String   @id @default(uuid())
  name                  String   @default("TroopTreasury")
  council               String?
  district              String?
  address               String?
  rolePermissions       Json?
  sessionTimeoutMinutes Int      @default(15)
  updatedAt             DateTime @updatedAt
}

model Budget {
  id               String           @id @default(uuid())
  troopId          String
  year             String
  status           BudgetStatus     @default(DRAFT)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  annualDuesAmount Decimal          @default(150.00) @db.Decimal(10, 2)
  troop            Troop            @relation(fields: [troopId], references: [id])
  categories       BudgetCategory[]
}

model BudgetCategory {
  id             String             @id @default(uuid())
  budgetId       String
  name           String
  type           BudgetCategoryType
  plannedIncome  Decimal            @default(0) @db.Decimal(10, 2)
  plannedExpense Decimal            @default(0) @db.Decimal(10, 2)
  budget         Budget             @relation(fields: [budgetId], references: [id])
  transactions   Transaction[]
}

model FundraisingCampaign {
  id                   String                 @id @default(uuid())
  troopId              String
  name                 String
  startDate            DateTime
  endDate              DateTime?
  goal                 Decimal                @db.Decimal(10, 2)
  isComplianceApproved Boolean                @default(false)
  ibaPercentage        Int                    @default(0)
  status               FundraisingStatus      @default(DRAFT)
  type                 FundraisingType        @default(GENERAL)
  description          String?
  ticketPrice          Decimal?               @db.Decimal(10, 2)
  volunteerPercentage  Decimal?               @default(0) @db.Decimal(5, 2)
  sendThankYou         Boolean                @default(false)
  thankYouTemplate     String?
  sendEventInvite      Boolean                @default(false)
  products             CampaignProduct[]
  directSalesGroups    DirectSalesGroup[]
  directSalesInventory DirectSalesInventory[]
  troop                Troop                  @relation(fields: [troopId], references: [id])
  orders               FundraisingOrder[]
  sales                FundraisingSale[]
  volunteers           FundraisingVolunteer[]
  transactions         Transaction[]
}

model CampaignProduct {
  id                   String                 @id @default(uuid())
  campaignId           String
  name                 String
  price                Decimal                @db.Decimal(10, 2)
  cost                 Decimal                @db.Decimal(10, 2)
  ibaAmount            Decimal                @db.Decimal(10, 2)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  campaign             FundraisingCampaign    @relation(fields: [campaignId], references: [id])
  directSalesInventory DirectSalesInventory[]
  orders               FundraisingOrder[]

  @@index([campaignId])
}

model FundraisingVolunteer {
  id         String              @id @default(uuid())
  campaignId String
  scoutId    String
  createdAt  DateTime            @default(now())
  campaign   FundraisingCampaign @relation(fields: [campaignId], references: [id])
  scout      Scout               @relation(fields: [scoutId], references: [id])

  @@unique([campaignId, scoutId])
}

model FundraisingOrder {
  id            String              @id @default(uuid())
  campaignId    String
  scoutId       String
  productId     String?
  customerName  String
  customerEmail String?
  quantity      Int
  amountPaid    Decimal             @default(0) @db.Decimal(10, 2)
  delivered     Boolean             @default(false)
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  campaign      FundraisingCampaign @relation(fields: [campaignId], references: [id])
  product       CampaignProduct?    @relation(fields: [productId], references: [id])
  scout         Scout               @relation(fields: [scoutId], references: [id])
}

model FundraisingSale {
  id         String              @id @default(uuid())
  campaignId String
  scoutId    String
  quantity   Int
  createdAt  DateTime            @default(now())
  updatedAt  DateTime            @updatedAt
  campaign   FundraisingCampaign @relation(fields: [campaignId], references: [id])
  scout      Scout               @relation(fields: [scoutId], references: [id])

  @@unique([campaignId, scoutId])
}

model DirectSalesInventory {
  id         String                 @id @default(uuid())
  campaignId String
  productId  String
  quantity   Int
  createdAt  DateTime               @default(now())
  updatedAt  DateTime               @updatedAt
  groupItems DirectSalesGroupItem[]
  campaign   FundraisingCampaign    @relation(fields: [campaignId], references: [id])
  product    CampaignProduct        @relation(fields: [productId], references: [id])

  @@index([campaignId])
}

model DirectSalesGroup {
  id         String                      @id @default(uuid())
  campaignId String
  name       String
  createdAt  DateTime                    @default(now())
  updatedAt  DateTime                    @updatedAt
  campaign   FundraisingCampaign         @relation(fields: [campaignId], references: [id])
  items      DirectSalesGroupItem[]
  volunteers DirectSalesGroupVolunteer[]

  @@index([campaignId])
}

model DirectSalesGroupItem {
  id              String               @id @default(uuid())
  groupId         String
  inventoryId     String
  quantity        Int
  soldCount       Int                  @default(0)
  amountCollected Decimal              @default(0) @db.Decimal(10, 2)
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  group           DirectSalesGroup     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  inventory       DirectSalesInventory @relation(fields: [inventoryId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@index([inventoryId])
}

model DirectSalesGroupVolunteer {
  id        String           @id @default(uuid())
  groupId   String
  scoutId   String?
  userId    String?
  createdAt DateTime         @default(now())
  group     DirectSalesGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  scout     Scout?           @relation(fields: [scoutId], references: [id])
  user      User?            @relation(fields: [userId], references: [id])

  @@unique([groupId, scoutId])
  @@unique([groupId, userId])
  @@index([groupId])
}

model AdminAuditLog {
  id        String   @id @default(uuid())
  adminId   String
  action    String
  targetId  String?
  details   Json?
  createdAt DateTime @default(now())
  admin     User     @relation(fields: [adminId], references: [id])
}

model WebhookEvent {
  id            String    @id @default(uuid())
  eventType     String
  stripeEventId String    @unique
  payload       Json
  processed     Boolean   @default(false)
  error         String?
  retryCount    Int       @default(0)
  createdAt     DateTime  @default(now())
  processedAt   DateTime?
}

enum NotificationType {
  SYSTEM
  ALERT
  INFO
  ACTION_REQUIRED
}

enum FundraisingType {
  GENERAL
  PRODUCT_SALE
}

enum FundraisingStatus {
  DRAFT
  ACTIVE
  CLOSED
}

enum Role {
  PLATFORM_ADMIN
  ADMIN
  FINANCIER
  LEADER
  SCOUT
  PARENT
}

enum ScoutStatus {
  ACTIVE
  INACTIVE
}

enum CampoutStatus {
  DRAFT
  OPEN
  READY_FOR_PAYMENT
  CLOSED
}

enum CampoutAdultRole {
  ORGANIZER
  ATTENDEE
}

enum RegistrationStatus {
  RESERVED
  WAITLISTED
}


enum TransactionType {
  REGISTRATION_INCOME
  FUNDRAISING_INCOME
  DONATION_IN
  EXPENSE
  CAMP_TRANSFER
  REIMBURSEMENT
  DUES
  IBA_RECLAIM
  EVENT_PAYMENT
  TROOP_PAYMENT
  IBA_DEPOSIT
  SCOUT_CASH_TURN_IN
  INTERNAL_TRANSFER
}

enum TransactionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum BudgetCategoryType {
  INCOME
  EXPENSE
  BOTH
}

enum BudgetStatus {
  DRAFT
  ACTIVE
  CLOSED
}

enum TroopStatus {
  PENDING_PAYMENT
  ACTIVE
  PAUSED
  GRACE_PERIOD
  PENDING_DELETION
}

model EagleProject {
  id          String   @id @default(uuid())
  scoutId     String
  title       String
  description String?
  beneficiary String?
  status      EagleProjectStatus @default(OPEN)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  scout       Scout    @relation(fields: [scoutId], references: [id])
  financials  EagleProjectFinancial[]
  workDays    EagleProjectWorkDay[]
}

model EagleProjectFinancial {
  id          String   @id @default(uuid())
  projectId   String
  type        EagleFinancialType
  amount      Decimal  @db.Decimal(10, 2)
  description String
  category    String?  // e.g., "Materials", "Supplies", "Tools"
  date        DateTime @default(now())
  
  project     EagleProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model EagleProjectWorkDay {
  id           String   @id @default(uuid())
  projectId    String
  date         DateTime
  startTime    DateTime?
  endTime      DateTime?
  notes        String?
  checkInToken String   @default(uuid())
  
  project      EagleProject @relation(fields: [projectId], references: [id], onDelete: Cascade)
  volunteers   EagleProjectVolunteer[]
}

model EagleProjectVolunteer {
  id           String   @id @default(uuid())
  workDayId    String
  name         String   // Can be arbitrary for non-users
  userId       String?  // Optional link to system user
  hours        Decimal  @db.Decimal(5, 2)
  role         EagleVolunteerRole @default(OTHER) // Scout, Adult, Other
  checkInTime  DateTime?
  checkOutTime DateTime?
  
  workDay      EagleProjectWorkDay @relation(fields: [workDayId], references: [id], onDelete: Cascade)
}

enum EagleProjectStatus {
  OPEN
  CLOSED
}

enum EagleFinancialType {
  INCOME
  EXPENSE
}

enum EagleVolunteerRole {
  EAGLE_CANDIDATE
  REGISTERED_SCOUT
  REGISTERED_ADULT
  OTHER
}
